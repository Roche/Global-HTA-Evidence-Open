context("Must calculate the survivor function estimates for each study and arm from a `rjags` object with control of cut points with argument `cut.pts`")

test_that("`get_pwe_GoF`", {
  # load rjags fit list object from tests/data
  # for details on how this object was generated refer to the generation script:
  # tests/data/rjags_generation.R
  rjags_list_ex <- readRDS(file.path("data", "rjags_output_list.RDS"))
  
  rjags_list_ex[[1]]$fit$model.pars$cut.pts <- rjags_list_ex[[1]]$model.pars$cut.pts # cut points pulled from fit

  output <- get_pwe_GoF(fit = rjags_list_ex[[1]]$fit,
                               data.arms = rjags_list_ex[[1]]$data.arms,
                               data.jg = rjags_list_ex[[1]]$data.jg)

  # check class
  expect_is(output, "data.frame")
  # check names
  expect_named(output, c("time", "S", "lCrI",
                         "uCrI", "study", "arm",
                         "treatment", "type"))
  #  check (some) values
  expect_equal(output$time[1:50], 0:49)
  expect_equal(output$time[1498:1543], 0:45)
  expect_equal(output$S[1:50], c(1,
                                 0.975007732340411, 0.950640078123591,
                                 0.926881426843194, 0.904633852012445,
                                 0.882921917317292, 0.861727884647881,
                                 0.841040704452697, 0.820856908602063,
                                 0.80115419909621, 0.781925858687736,
                                 0.764292388439399, 0.74705882580046,
                                 0.730209735370434, 0.713727669979965,
                                 0.697648769790928, 0.681913162907891,
                                 0.666531675691682, 0.651502555815483,
                                 0.636812258891289, 0.622452310945091,
                                 0.60841007513705, 0.594694734515725,
                                 0.581281864926829, 0.568176687437487,
                                 0.555360451001484, 0.542838627576872,
                                 0.530594810027564, 0.518619981157869,
                                 0.506943974383481, 0.495504126032139,
                                 0.484328553036601, 0.47340614004257,
                                 0.462731403886254, 0.452292781766419,
                                 0.442096831079664, 0.432124647305108,
                                 0.422298240963801, 0.412855790595615,
                                 0.403560297901175, 0.394445585152674,
                                 0.385549066529204, 0.376857449973516,
                                 0.368355925690171, 0.360050327863138,
                                 0.351933351832538, 0.343993266980534,
                                 0.336238618779694, 0.328655291890419,
                                 0.321246839427083))

  expect_equal(output$lCrI[1:50], c(1,
                                    0.960950580682783, 0.923426018514577,
                                    0.887366768709173, 0.857742921324373,
                                    0.829108036299697, 0.801429098121087,
                                    0.774671884850256, 0.748812474399057,
                                    0.723814122822627, 0.699648433279512,
                                    0.679533007777703, 0.660012190025932,
                                    0.641041007296125, 0.622619730130156,
                                    0.604735877058197, 0.587345709981685,
                                    0.570465561792109, 0.554069024174205,
                                    0.538151888847835, 0.522678307915042,
                                    0.507662563545982, 0.49306097329126,
                                    0.478893578662888, 0.465133360613044,
                                    0.451761657467859, 0.438778901064388,
                                    0.426162968491025, 0.413922785145379,
                                    0.402032659441264, 0.390472322597273,
                                    0.379247798831101, 0.368350427147803,
                                    0.357766245754891, 0.347481965725388,
                                    0.33749938287119, 0.327796000688596,
                                    0.318375357245849, 0.309223502099116,
                                    0.300360586744191, 0.291707419306873,
                                    0.283324207582159, 0.275181871906563,
                                    0.267268964896832, 0.259587531007908,
                                    0.252134876806061, 0.244880733783981,
                                    0.237839485737157, 0.231008816228861,
                                    0.224386098525551))

  expect_equal(output$uCrI[1:50], c(1,
                                    0.985127546020477, 0.970476281928327,
                                    0.956042918087129, 0.939983795014919,
                                    0.924191114660797, 0.908670276661017,
                                    0.893413406578526, 0.878399900153708,
                                    0.863644985038172, 0.849134874054895,
                                    0.834432000142954, 0.819983461810471,
                                    0.805783863935604, 0.791822831461716,
                                    0.778101113420233, 0.764635894085914,
                                    0.751390841955348, 0.73838326352038,
                                    0.72559188357019, 0.713023905693819,
                                    0.700673903350101, 0.688543059662858,
                                    0.676619885996474, 0.664902535130701,
                                    0.653388238181002, 0.642072697685389,
                                    0.630945403171087, 0.620020998650075,
                                    0.609280466989354, 0.598731289735376,
                                    0.588353299503938,0.578173978728267,
                                    0.568162093571796, 0.558319118504929,
                                    0.548650928096681, 0.539151959132901,
                                    0.529814307571486, 0.52063636704759,
                                    0.511625650370472, 0.502757915344146,
                                    0.494056864957965, 0.485493600637222,
                                    0.477090604688029, 0.468825703186409,
                                    0.460702645891242, 0.452729657319017,
                                    0.444891179431246, 0.43718351753789,
                                    0.429603801991226))

  # check slice where values are mixture of studies
  expect_equal(output$study[76:125], factor(c("STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2", "STUDY2",
                                              "STUDY2", "STUDY2","STUDY1",
                                              "STUDY1", "STUDY1"),
                                            levels = c(
                                            "STUDY1", "STUDY2", "STUDY3",
                                            "STUDY4", "STUDY5", "STUDY6",
                                            "STUDY7"
                                            )
    ))
  # checking arm values 51:100 (otherwise it's just 1's)
  expect_equal(output$arm[51:100], c(1L, 1L, 1L, 1L, 1L, 1L, 1L,
                                     1L, 1L, 1L, 1L, 2L, 2L, 2L,
                                     2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                     2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                     2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                     2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                     2L, 2L, 2L, 2L, 2L, 2L, 2L,
                                     2L))

  expect_equal(output$treatment[76:125], c("C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "C", "C",
                                           "C", "C", "C", "C", "C", "D", "D",
                                           "D"))

  expect_equal(output$type[851:900], c("nma", "nma", "nma", "nma", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs",
                                       "obs", "obs", "obs", "obs", "obs"))


})










