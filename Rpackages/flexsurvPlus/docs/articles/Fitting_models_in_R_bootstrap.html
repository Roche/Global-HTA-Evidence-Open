<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSA and correlated endpoints (bootstrap approach) • flexsurvPlus</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="PSA and correlated endpoints (bootstrap approach)">
<meta property="og:description" content="flexsurvPlus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-181075487-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-181075487-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flexsurvPlus</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.02</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://roche.github.io/Global-HTA-Evidence-Open/Rpackages/flexsurvPlus/docs/index.html">flexsurvPlus</a>
    </li>
    <li>
      <a href="https://roche.github.io/Global-HTA-Evidence-Open/Rpackages/gemtcPlus/docs/index.html">gemtcPlus</a>
    </li>
    <li>
      <a href="https://roche.github.io/Global-HTA-Evidence-Open/Rpackages/MAIC/docs/index.html">MAIC</a>
    </li>
    <li>
      <a href="https://roche.github.io/Global-HTA-Evidence-Open/Rpackages/rpsftmPlus/docs/index.html">rpsftmPlus</a>
    </li>
    <li>
      <a href="https://roche.github.io/Global-HTA-Evidence-Open/Rpackages/descem/docs/index.html">descem</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Roche/Global-HTA-Evidence-Open/tree/master/Rpackages/flexsurvPlus">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Fitting_models_in_R_bootstrap_files/header-attrs-2.5/header-attrs.js"></script><script src="Fitting_models_in_R_bootstrap_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="Fitting_models_in_R_bootstrap_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="Fitting_models_in_R_bootstrap_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>PSA and correlated endpoints (bootstrap approach)</h1>
                        <h4 class="author">Roche</h4>
            
            <h4 class="date">2021-08-03</h4>
      
      
      <div class="hidden name"><code>Fitting_models_in_R_bootstrap.Rmd</code></div>

    </div>

    
    
<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 38px;
}
h1 { /* Header 1 */
  font-size: 28px;
  }
h2 { /* Header 2 */
    font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Parametric survival models are often the preferred method of extrapolating survival in economic modeling. When doing such modeling it is important to account for uncertainty in the estimates.</p>
<p>The flexsurvPlus package allows the handling of uncertainty in estimates primarily through boot strapping. The primary use of these bootstrap samples is to be used in probabilistic sensitivity analyses (PSA) in economic models. This is simpler to execute than the the traditional method in Excel using the variance covariance matrix and the cholesky decomposition as we now just need to sample from a list of parameters.</p>
<p>In addition this enables correlations between different endpoints to be preserved in the excel models. For example, if we expect that time to progression correlates positively with survival, then the random draws should also reflect this correlation, rather than just being drawn independently, which could lead to unrealistic iterations with large OS but minimal PFS, and vice versa. This vignette illustrates this with a simple example.</p>
<p># Set up packages and data</p>
<div id="install-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#install-packages" class="anchor"></a>Install packages</h2>
<p>The following packages are required to run this example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">flexsurvPlus</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></pre></div>
</div>
<div id="read-in-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#read-in-the-data" class="anchor"></a>Read in the data</h2>
<p>To perform survival analyses, patient level data is required for the survival endpoints.</p>
<p>This example uses a standard simulated data set (adtte). There is no standard naming that is needed for this package however, there are some set variables that are needed:</p>
<ul>
<li>Time - a numeric variable</li>
<li>Event - a binary variable (event=1, censor=0)</li>
</ul>
<p>In this example, we use overall survival (OS) and progression-free survival (PFS). For the purposes of this example we will look at only a single arm trial.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">


<span class="co"># simulate data with a medium correlation between PFS &amp; OS on the patient level</span>
<span class="va">adtte</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_adtte.html">sim_adtte</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">2020</span>, <span class="co"># for reproducibility</span>
                   rho <span class="op">=</span> <span class="fl">0.6</span> <span class="co"># defines a correlation on underlying survival times</span>
                   <span class="op">)</span> 

<span class="co"># subset OS data for reference arm and rename</span>
<span class="va">OS_data</span> <span class="op">&lt;-</span> <span class="va">adtte</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">==</span><span class="st">"OS"</span>, <span class="va">ARMCD</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">USUBJID</span>,
            OS_days <span class="op">=</span> <span class="va">AVAL</span>,
            OS_event <span class="op">=</span> <span class="fl">1</span><span class="op">-</span> <span class="va">CNSR</span>
  <span class="op">)</span>

<span class="co"># subset PFS data for reference arm and rename</span>
<span class="va">PFS_data</span> <span class="op">&lt;-</span> <span class="va">adtte</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span><span class="op">==</span><span class="st">"PFS"</span>, <span class="va">ARMCD</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">USUBJID</span>,
            PFS_days <span class="op">=</span> <span class="va">AVAL</span>,
            PFS_event <span class="op">=</span> <span class="fl">1</span><span class="op">-</span> <span class="va">CNSR</span>
  <span class="op">)</span>

<span class="va">analysis_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">OS_data</span>, <span class="va">PFS_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The Kaplan-Meier curves are plotted below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">km.est.PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">PFS_days</span>, <span class="va">PFS_event</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, 
                      data <span class="op">=</span> <span class="va">analysis_data</span><span class="op">)</span>

<span class="va">km.est.OS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">OS_days</span>, <span class="va">OS_event</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, 
                      data <span class="op">=</span> <span class="va">analysis_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot Kaplan-Meier</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">km.est.PFS</span>,
     xlab <span class="op">=</span> <span class="st">"Time (Days)"</span>, <span class="co"># x-axis label</span>
     ylab <span class="op">=</span> <span class="st">"Progression-free survival"</span>, <span class="co"># y-axis label</span>
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span> 

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">km.est.OS</span>,
     xlab <span class="op">=</span> <span class="st">"Time (Days)"</span>, <span class="co"># x-axis label</span>
     ylab <span class="op">=</span> <span class="st">"Overall survival"</span>, <span class="co"># y-axis label</span>
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span> </pre></div>
<p><img src="Fitting_models_in_R_bootstrap_files/figure-html/unnamed-chunk-4-1.png" width="864"></p>
<div class="sourceCode" id="cb4"><pre class="downlit">

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
</div>
<div id="bootstrapping-the-endpoints" class="section level1">
<h1 class="hasAnchor">
<a href="#bootstrapping-the-endpoints" class="anchor"></a>Bootstrapping the endpoints</h1>
<p>We can use the bootPSM function with the boot package to generate bootstrap samples. In this example we have used OS and PFS. For speed of execution and illustration of concept we only fit a weibull model for PFS and a gamma models for OS here but all models discussed in <tt>runPSM</tt> could be specified with a single call.</p>
<div id="ignoring-correlation-between-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#ignoring-correlation-between-endpoints" class="anchor"></a>Ignoring correlation between endpoints</h2>
<p>If we are not concerned about correlations between endpoints we can generate independent samples for OS and PFS as shown below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">

<span class="co"># fix a seed for the sampling</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2358</span><span class="op">)</span>

<span class="co"># define a number of samples to generate. For illustration 100 are taken</span>
<span class="co"># In practice a larger number is preferable.</span>
<span class="va">n.sim</span> <span class="op">&lt;-</span> <span class="fl">100</span>

<span class="va">PSM_bootstraps_PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>
  statistic <span class="op">=</span> <span class="va">bootPSM</span>, <span class="co"># bootstrap function</span>
  R<span class="op">=</span><span class="va">n.sim</span>, <span class="co"># number of bootstrap samples</span>
  data<span class="op">=</span><span class="va">analysis_data</span>, <span class="co"># the dataset</span>
  time_var<span class="op">=</span><span class="st">"PFS_days"</span>, <span class="co"># the time variable</span>
  event_var<span class="op">=</span><span class="st">"PFS_event"</span>, <span class="co"># the event variable coded as 1 for event</span>
  model.type<span class="op">=</span> <span class="st">"One arm"</span>, 
  distr <span class="op">=</span> <span class="st">"weibull"</span>, <span class="co"># for speed we only fit a single model but multiple could be specified,</span>
  int_name <span class="op">=</span> <span class="st">"A"</span>  <span class="co"># needed for one arm even as essential meta data</span>
<span class="op">)</span>

<span class="va">PSM_bootstraps_OS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>
  statistic <span class="op">=</span> <span class="va">bootPSM</span>, <span class="co"># bootstrap function</span>
  R<span class="op">=</span><span class="va">n.sim</span>, <span class="co"># number of bootstrap samples</span>
  data<span class="op">=</span><span class="va">analysis_data</span>, <span class="co"># the dataset</span>
  time_var<span class="op">=</span><span class="st">"OS_days"</span>,  <span class="co"># the time variable</span>
  event_var<span class="op">=</span><span class="st">"OS_event"</span>, <span class="co"># the event variable coded as 1 for event</span>
  model.type<span class="op">=</span><span class="st">"One arm"</span>, <span class="co"># again for speed only a single model is specified</span>
  distr <span class="op">=</span> <span class="st">"gamma"</span>, 
  int_name <span class="op">=</span> <span class="st">"A"</span>  <span class="co"># needed for one arm even as essential meta data</span>
<span class="op">)</span></pre></div>
<p>We can see these are using different bootstrap samples by looking at the bootstrap indexes. This is equivalent to performing PSA for OS and PFS independently in an Excel based model using two independent covariance matrices.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">

<span class="va">index_PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.array.html">boot.array</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFS</span>, indices <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">index_OS</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.array.html">boot.array</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OS</span>, indices <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">index_OS</span> <span class="op">==</span> <span class="va">index_PFS</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></pre></div>
</div>
<div id="considering-correlation-between-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#considering-correlation-between-endpoints" class="anchor"></a>Considering correlation between endpoints</h2>
<p>If we want to maintain correlations between PFS and OS we need to use the same bootstrap samples for both the PFS and OS analysis. The easiest way to do this is to reuse the same seed before calling the boot function for the second endpoint. This use of a common seed means the same underlying random sampling process will be performed leading to a matching bootstrap sample.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">

<span class="co"># for illustration and speed only 100 samples used</span>
<span class="va">n.sim</span> <span class="op">&lt;-</span> <span class="fl">100</span>

<span class="co"># define a seed that will affect the random numbers used by boot for sampling </span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>

<span class="va">PSM_bootstraps_PFScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>
  statistic <span class="op">=</span> <span class="va">bootPSM</span>, <span class="co"># bootstrap function</span>
  R<span class="op">=</span><span class="va">n.sim</span>, <span class="co"># number of bootstrap samples</span>
  data<span class="op">=</span><span class="va">analysis_data</span>, <span class="co"># the dataset</span>
  time_var<span class="op">=</span><span class="st">"PFS_days"</span>, <span class="co"># the time variable</span>
  event_var<span class="op">=</span><span class="st">"PFS_event"</span>, <span class="co"># the event variable coded as 1 for event</span>
  model.type<span class="op">=</span> <span class="st">"One arm"</span>, 
  distr <span class="op">=</span> <span class="st">"weibull"</span>, <span class="co"># for speed we only fit a single model but multiple could be specified,</span>
  int_name <span class="op">=</span> <span class="st">"A"</span>  <span class="co"># needed for one arm even as essential meta data</span>
<span class="op">)</span>

<span class="co"># reuse the same seed that will affect the random numbers used by boot for sampling </span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2020</span><span class="op">)</span>

<span class="va">PSM_bootstraps_OScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>
  statistic <span class="op">=</span> <span class="va">bootPSM</span>, <span class="co"># bootstrap function</span>
  R<span class="op">=</span><span class="va">n.sim</span>, <span class="co"># number of bootstrap samples</span>
  data<span class="op">=</span><span class="va">analysis_data</span>, <span class="co"># the dataset</span>
  time_var<span class="op">=</span><span class="st">"OS_days"</span>,  <span class="co"># the time variable</span>
  event_var<span class="op">=</span><span class="st">"OS_event"</span>, <span class="co"># the event variable coded as 1 for event</span>
  model.type<span class="op">=</span><span class="st">"One arm"</span>, <span class="co"># again for speed only a single model is specified</span>
  distr <span class="op">=</span> <span class="st">"gamma"</span>, 
  int_name <span class="op">=</span> <span class="st">"A"</span>  <span class="co"># needed for one arm even as essential meta data</span>
<span class="op">)</span></pre></div>
<p>We can check these are indeed using the same bootstrap samples by comparing the indexes selected. This means the associated bootstrap distributions for PFS and OS should remain correlated.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># this returns the indexes selected in each sample</span>
<span class="va">index_PFScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.array.html">boot.array</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFScor</span>, indices <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">index_OScor</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.array.html">boot.array</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OScor</span>, indices <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># as desired all match between the two sampled sets</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">index_OScor</span> <span class="op">==</span> <span class="va">index_PFScor</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></pre></div>
</div>
<div id="plotting-impact-of-accounting-for-correlations-between-endpoints" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-impact-of-accounting-for-correlations-between-endpoints" class="anchor"></a>Plotting impact of accounting for correlations between endpoints</h2>
<p>To illustrate the impact of accounting for correlations between each endpoint in such PSA we will look at plotting the extrapolated mean PFS and mean OS for the reference arm. To do this we need to calculate the mean PFS and mean OS for the reference for each sample.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">

<span class="co"># first we need to preprocess the data a little bit</span>
<span class="co"># first extract the bootstrapped parameters into tibbles</span>
<span class="va">bootsamples_PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFS</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>
<span class="co">#&gt; Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if `.name_repair` is omitted as of tibble 2.0.0.</span>
<span class="co">#&gt; Using compatibility `.name_repair`.</span>
<span class="va">bootsamples_OS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OS</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>
<span class="va">bootsamples_PFScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFScor</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>
<span class="va">bootsamples_OScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OScor</span><span class="op">$</span><span class="va">t</span><span class="op">)</span>

<span class="co"># then add column names so can identify model and parameter more easily</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">bootsamples_PFS</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFS</span><span class="op">$</span><span class="va">t0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">bootsamples_OS</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OS</span><span class="op">$</span><span class="va">t0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">bootsamples_PFScor</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PSM_bootstraps_PFScor</span><span class="op">$</span><span class="va">t0</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">bootsamples_OScor</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PSM_bootstraps_OScor</span><span class="op">$</span><span class="va">t0</span><span class="op">)</span>

<span class="co"># we can then calculate extrapolated means for each sample</span>

<span class="va">mean_PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bootsamples_PFS</span>, <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/means.html">mean_weibull</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">onearm.weibull.scale.int</span>, shape <span class="op">=</span> <span class="va">onearm.weibull.shape.int</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_OS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bootsamples_OS</span>, <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/means.html">mean_gamma</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">onearm.gamma.shape.int</span>, rate <span class="op">=</span> <span class="va">onearm.gamma.rate.int</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_PFScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bootsamples_PFScor</span>, <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/means.html">mean_weibull</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="va">onearm.weibull.scale.int</span>, shape <span class="op">=</span> <span class="va">onearm.weibull.shape.int</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_OScor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bootsamples_OScor</span>, <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/means.html">mean_gamma</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">onearm.gamma.shape.int</span>, rate <span class="op">=</span> <span class="va">onearm.gamma.rate.int</span><span class="op">)</span><span class="op">)</span>

<span class="co"># we can now combine in a tibble for plotting</span>

<span class="va">means_both</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>PFS <span class="op">=</span> <span class="va">mean_PFS</span>, OS <span class="op">=</span> <span class="va">mean_OS</span>, sample_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.sim</span>, Bootstrap <span class="op">=</span> <span class="st">"uncorrelated"</span><span class="op">)</span>
<span class="va">means_bothcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>PFS <span class="op">=</span> <span class="va">mean_PFScor</span>, OS <span class="op">=</span> <span class="va">mean_OScor</span>, sample_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n.sim</span>, Bootstrap <span class="op">=</span> <span class="st">"correlated"</span><span class="op">)</span>

<span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">means_both</span>, <span class="va">means_bothcor</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 4</span>
<span class="co">#&gt;     PFS    OS sample_id Bootstrap   </span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;int&gt; &lt;chr&gt;       </span>
<span class="co">#&gt; 1  195. 1064.         1 uncorrelated</span>
<span class="co">#&gt; 2  199. 1018.         2 uncorrelated</span>
<span class="co">#&gt; 3  215. 1268.         3 uncorrelated</span>
<span class="co">#&gt; 4  199. 1069.         4 uncorrelated</span>
<span class="co">#&gt; 5  216. 1077.         5 uncorrelated</span>
<span class="co">#&gt; 6  204. 1094.         6 uncorrelated</span></pre></div>
<p>We can now plot this dataset and as expected the correlated bootstrap approach leads to mean estimates for PFS and OS that preserve the correlations in the underlying data. Here we use all bootstrap samples but in the context of an excel economic model we would perform PSA by randomly sampling sample_ID and using the same sample_ID for both PFS and OS in a single PSA run.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">

<span class="va">plot_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PFS</span>, y <span class="op">=</span> <span class="va">OS</span>, color <span class="op">=</span> <span class="va">Bootstrap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">250</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">750</span>, <span class="fl">1750</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mean (weibull) PFS days"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Mean (gamma) OS days"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Each point is a bootstrap sample"</span><span class="op">)</span></pre></div>
<p><img src="Fitting_models_in_R_bootstrap_files/figure-html/unnamed-chunk-10-1.png" width="864"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Iain Bennett, Jo Gregory, Sarah Smith, Richard Birnie.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
